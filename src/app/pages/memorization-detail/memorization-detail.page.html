<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button defaultHref="/tabs/tab1">
        <ion-icon name="arrow-back"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>{{ item?.title }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <div *ngIf="item">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Content to Memorize</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <p>{{ item.content }}</p>
      </ion-card-content>
    </ion-card>

    <ion-card>
      <ion-card-header>
        <ion-card-title>Practice</ion-card-title>
        <ion-card-subtitle>
          Click the microphone button and start speaking
        </ion-card-subtitle>
      </ion-card-header>
      
      <ion-card-content>
        <div class="transcript-container">
          <!-- Progressive Word Revelation -->
          <div class="revealed-words">
            <span *ngFor="let revealedWord of revealedWords" 
                  [class.revealed]="revealedWord.isRevealed"
                  [class.hidden]="!revealedWord.isRevealed"
                  [class.correct]="revealedWord.isCorrect">
              {{ revealedWord.isRevealed ? revealedWord.word : '‚Ä¢‚Ä¢‚Ä¢' }}
            </span>
          </div>
          <p *ngIf="revealedWords.length === 0" class="placeholder">
            Your speech will appear here...
          </p>
        </div>

        <div class="accuracy-container" *ngIf="getRevealedWordsCount() > 0">
          <ion-progress-bar 
            [value]="getRevealedWordsCount() / getTotalWordsCount()" 
            [color]="accuracy > 80 ? 'success' : 'warning'">
          </ion-progress-bar>
          <p class="accuracy-text">
            Progress: {{ getRevealedWordsCount() }} / {{ getTotalWordsCount() }} words
            <span *ngIf="accuracy > 0"> ‚Ä¢ Accuracy: {{ accuracy | number:'1.0-0' }}%</span>
          </p>
        </div>

        <div class="button-container">
          <ion-button expand="block" (click)="toggleListening()" [color]="isListening ? 'danger' : 'primary'">
            <ion-icon slot="start" [name]="isListening ? 'mic' : 'mic-outline'"></ion-icon>
            {{ isListening ? 'Stop' : 'Start' }} Practice
          </ion-button>
          
          <ion-button expand="block" 
                      fill="outline" 
                      color="warning" 
                      (click)="skipCurrentWord()"
                      *ngIf="canSkipWord && isListening">
            <ion-icon slot="start" name="play-skip-forward-outline"></ion-icon>
            Skip Word ({{ failedAttempts }}/3 attempts)
          </ion-button>
          
          <ion-button expand="block" 
                      fill="outline" 
                      color="secondary" 
                      (click)="toggleAlignmentViewer()"
                      *ngIf="getRevealedWordsCount() > 0">
            <ion-icon slot="start" name="analytics-outline"></ion-icon>
            {{ showAlignmentViewer ? 'Hide' : 'Show' }} Detailed Analysis
          </ion-button>
          
          <ion-button expand="block" 
                      fill="outline" 
                      color="medium" 
                      (click)="resetPractice()"
                      *ngIf="getRevealedWordsCount() > 0">
            <ion-icon slot="start" name="refresh-outline"></ion-icon>
            Reset Practice
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Debug Panel for Matching Issues -->
    <ion-card *ngIf="isListening && matchResult && currentTranscript" color="light">
      <ion-card-header>
        <ion-card-title>üîç Debug Info</ion-card-title>
        <ion-card-subtitle>Help identify matching issues</ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item>
            <ion-label>
              <h3>Similarity Threshold</h3>
              <p>Words must match at {{ (SIMILARITY_THRESHOLD * 100) | number:'1.0-0' }}% to be revealed</p>
            </ion-label>
          </ion-item>
          <ion-item *ngIf="hasUnrevealedWords()">
            <ion-label>
              <h3>Next Expected Word</h3>
              <p style="font-size: 1.2em; font-weight: bold;">
                {{ getNextExpectedWord() }}
              </p>
            </ion-label>
          </ion-item>
          <ion-item *ngIf="getUnmatchedWords().length > 0">
            <ion-label>
              <h3>Unmatched Words You Said</h3>
              <p style="color: var(--ion-color-danger);">
                <span *ngFor="let word of getUnmatchedWords(); let last = last">
                  {{ word }}<span *ngIf="!last"> ‚Ä¢ </span>
                </span>
              </p>
              <p class="ion-text-wrap" style="font-size: 0.85em; color: var(--ion-color-medium);" *ngIf="getLastUnmatchedWordInfo()">
                {{ getLastUnmatchedWordInfo() }}
              </p>
              <p class="ion-text-wrap" style="font-size: 0.9em; color: var(--ion-color-medium);">
                These words didn't match the expected word closely enough (need {{ (SIMILARITY_THRESHOLD * 100) | number:'1.0-0' }}% similarity). Check console for exact scores.
              </p>
            </ion-label>
          </ion-item>
          <ion-item>
            <ion-label>
              <h3>Current Transcript</h3>
              <p class="ion-text-wrap">{{ currentTranscript }}</p>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <!-- Text Alignment Viewer -->
    <app-text-alignment-viewer
      *ngIf="showAlignmentViewer && item && currentTranscript"
      [referenceText]="item.content"
      [hypothesisText]="currentTranscript"
      [normalizer]="normalizeArabicForAlignment"
      [showMetrics]="true"
      [showDiff]="true">
    </app-text-alignment-viewer>

    <ion-card>
      <ion-card-header>
        <ion-card-title>Statistics</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item>
            <ion-label>Last Practiced</ion-label>
            <ion-note slot="end">{{ item.lastPracticed }}</ion-note>
          </ion-item>
          <ion-item>
            <ion-label>Best Accuracy</ion-label>
            <ion-badge slot="end" *ngIf="item.accuracy !== undefined">
              {{ item.accuracy | number:'1.0-0' }}%
            </ion-badge>
            <ion-note slot="end" *ngIf="item.accuracy === undefined">Not practiced yet</ion-note>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content> 